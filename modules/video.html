<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>video 的那些事 | suky blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="just for fun">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b6bfb1ac.css" as="style"><link rel="preload" href="/blog/assets/js/app.8a54f0e1.js" as="script"><link rel="preload" href="/blog/assets/js/2.99672014.js" as="script"><link rel="preload" href="/blog/assets/js/17.55ad85a5.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.30098915.js"><link rel="prefetch" href="/blog/assets/js/11.01a7bb32.js"><link rel="prefetch" href="/blog/assets/js/12.f6a23b29.js"><link rel="prefetch" href="/blog/assets/js/13.783d2ca3.js"><link rel="prefetch" href="/blog/assets/js/14.bbca777a.js"><link rel="prefetch" href="/blog/assets/js/15.7aee58fc.js"><link rel="prefetch" href="/blog/assets/js/16.bc1a9abb.js"><link rel="prefetch" href="/blog/assets/js/18.58d328b7.js"><link rel="prefetch" href="/blog/assets/js/19.f10316de.js"><link rel="prefetch" href="/blog/assets/js/20.4c11b076.js"><link rel="prefetch" href="/blog/assets/js/21.ceb3b920.js"><link rel="prefetch" href="/blog/assets/js/22.5de30657.js"><link rel="prefetch" href="/blog/assets/js/23.f0173a34.js"><link rel="prefetch" href="/blog/assets/js/24.225aca0c.js"><link rel="prefetch" href="/blog/assets/js/25.8bd8c2c3.js"><link rel="prefetch" href="/blog/assets/js/3.1bd67bfe.js"><link rel="prefetch" href="/blog/assets/js/4.69e95b75.js"><link rel="prefetch" href="/blog/assets/js/5.83a5511f.js"><link rel="prefetch" href="/blog/assets/js/6.3c2a093e.js"><link rel="prefetch" href="/blog/assets/js/7.38b54764.js"><link rel="prefetch" href="/blog/assets/js/8.6ee2f7a3.js"><link rel="prefetch" href="/blog/assets/js/9.c792a14a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b6bfb1ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suky blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/modules/" class="nav-link router-link-active">
  功能实现
</a></div><div class="nav-item"><a href="/blog/theory/" class="nav-link">
  理论
</a></div><div class="nav-item"><a href="/blog/visualization/" class="nav-link">
  可视化
</a></div><div class="nav-item"><a href="/blog/engineering/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/else/" class="nav-link">
  其他
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/modules/" class="nav-link router-link-active">
  功能实现
</a></div><div class="nav-item"><a href="/blog/theory/" class="nav-link">
  理论
</a></div><div class="nav-item"><a href="/blog/visualization/" class="nav-link">
  可视化
</a></div><div class="nav-item"><a href="/blog/engineering/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/else/" class="nav-link">
  其他
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/modules/" aria-current="page" class="sidebar-link">基础知识</a></li><li><a href="/blog/modules/video.html" aria-current="page" class="active sidebar-link">video 的那些事</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/modules/video.html#video-的那些事" class="sidebar-link">video 的那些事</a></li></ul></li><li><a href="/blog/modules/vue-directive.html" class="sidebar-link">VUE 自定义指令便利店</a></li><li><a href="/blog/modules/vue-practice.html" class="sidebar-link">批量注册指令</a></li><li><a href="/blog/modules/web-worker.html" class="sidebar-link">❗ 实时推送-web worker</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="video-的那些事"><a href="#video-的那些事" class="header-anchor">#</a> video 的那些事</h2> <p>video 的标准就是展现我们前端有多乱的乱世枭雄的最大体现。</p> <h3 id="h5-视频固定大小播放"><a href="#h5-视频固定大小播放" class="header-anchor">#</a> H5 视频固定大小播放</h3> <p>加入<code>playsinline</code>是微信固定尺寸的关键 而<code>webkit-playsinline</code>是 IOS 固定尺寸的关键</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>video playsinline webkit<span class="token operator">-</span>playsinline <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre></div><h3 id="视频自动播放"><a href="#视频自动播放" class="header-anchor">#</a> 视频自动播放</h3> <h4 id="各大平台对自动播放的表现"><a href="#各大平台对自动播放的表现" class="header-anchor">#</a> 各大平台对自动播放的表现</h4> <ul><li>Firefox / QQ 浏览器 / 钉钉 使用 video autoplay 的表现良好</li> <li>移动端 Chrome
<ul><li>muted 可以自动静音播放</li> <li>引导用户做一次交互</li> <li>MEI 值高的网站</li></ul></li> <li>移动端 Safari
<ul><li>muted 可以自动静音播放</li> <li>引导用户做一次交互</li> <li>引导用户对浏览器设置为【允许自动播放】</li></ul></li> <li>移动端 UC 浏览器
<ul><li>引导用户做一次交互</li></ul></li></ul> <h3 id="如何解决"><a href="#如何解决" class="header-anchor">#</a> 如何解决</h3> <h4 id="微信端"><a href="#微信端" class="header-anchor">#</a> 微信端</h4> <p>需要用到<code>WeixinJSBridge</code>,需要对象准备好才能自动播放</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//监听 WeixinJSBridge 是否存在</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token keyword">typeof</span> WeixinJSBridge <span class="token operator">==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span>
  <span class="token keyword">typeof</span> WeixinJSBridge<span class="token punctuation">.</span>invoke <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vedio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">//监听客户端抛出事件&quot;WeixinJSBridgeReady&quot;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token string">&quot;WeixinJSBridgeReady&quot;</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vedio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token boolean">false</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">&quot;WeixinJSBridgeReady&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vedio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">&quot;onWeixinJSBridgeReady&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vedio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="视频短暂黑屏"><a href="#视频短暂黑屏" class="header-anchor">#</a> 视频短暂黑屏</h3> <p>部分 android 机型点击播放视频时，会出现短暂 1~2s 的黑屏。该问题出现可能是还没请求完成可顺利播放的视频</p> <p>解决方案：在视频上叠加一个 div，把它的背景图换成首帧图。监听 timeupdate 事件，有视频播放时移除该 div。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>play<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span>
    <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>video<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{<span class="token punctuation">'</span>playing<span class="token punctuation">'</span>: playing}<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:poster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>startSource<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">x-webkit-airplay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>allow<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">x5-video-player-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>h5<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">x5-playsinline</span>
    <span class="token attr-name">webkit-playsinline</span>
    <span class="token attr-name">playsinline</span>
  <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">:src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>videoSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>video/mp4<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[<span class="token punctuation">'</span>cover-start<span class="token punctuation">'</span>]<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>!playing<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>videoNode<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;timeupdate&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当视频的currentTime大于0.1时表示黑屏时间已过，已有视频画面，可以移除浮层</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>videoNode<span class="token punctuation">.</span>currentTime <span class="token operator">&gt;</span> <span class="token number">0.1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>playing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>playing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="部分-android-机跳到-x5-player-播放视频"><a href="#部分-android-机跳到-x5-player-播放视频" class="header-anchor">#</a> 部分 Android 机跳到 x5 player 播放视频</h3> <p>有些 android 在微信或浏览器，播放视频会跳到 x5 player 播放器中。这种 video 位于页面最顶层，无法被遮盖，说不定播完会推送腾讯视频信息，而且不会自动关掉。</p> <p>解决方案：利用 timeupdate 事件，当视频快要结束时，手动 remove 掉整个视频。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>videoNode<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;timeupdate&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 兼容Android X5在浏览器行为.时间为视频时长</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>videoNode<span class="token punctuation">.</span>currentTime <span class="token operator">&gt;</span> <span class="token number">56.9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isShowVideo <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="视频-canplay-的坑"><a href="#视频-canplay-的坑" class="header-anchor">#</a> 视频 canplay 的坑</h3> <p>换了引导用户的视频方案后，前面有个 loading 页面。产品希望视频加载好后，loading 消失并视频可点击。但是 ios 下 canplay 和 canplaythrough 事件都不会执行回调。ios 是点击播放后才会去加载视频流。android 下会执行 canplay 事件回调，但视频流也是边下边播。所以无法准确获得视频可加载时间点</p> <p>总结：H5 现在视频标准不完善，除了 timeupdate、ended 事件外，其他事件慎用。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/modules/" class="prev router-link-active">
        基础知识
      </a></span> <span class="next"><a href="/blog/modules/vue-directive.html">
        VUE 自定义指令便利店
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8a54f0e1.js" defer></script><script src="/blog/assets/js/2.99672014.js" defer></script><script src="/blog/assets/js/17.55ad85a5.js" defer></script>
  </body>
</html>
