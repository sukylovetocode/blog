<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CANVAS 的入门使用 | suky blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="just for fun">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b6bfb1ac.css" as="style"><link rel="preload" href="/blog/assets/js/app.8a54f0e1.js" as="script"><link rel="preload" href="/blog/assets/js/2.99672014.js" as="script"><link rel="preload" href="/blog/assets/js/24.225aca0c.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.30098915.js"><link rel="prefetch" href="/blog/assets/js/11.01a7bb32.js"><link rel="prefetch" href="/blog/assets/js/12.f6a23b29.js"><link rel="prefetch" href="/blog/assets/js/13.783d2ca3.js"><link rel="prefetch" href="/blog/assets/js/14.bbca777a.js"><link rel="prefetch" href="/blog/assets/js/15.7aee58fc.js"><link rel="prefetch" href="/blog/assets/js/16.bc1a9abb.js"><link rel="prefetch" href="/blog/assets/js/17.55ad85a5.js"><link rel="prefetch" href="/blog/assets/js/18.58d328b7.js"><link rel="prefetch" href="/blog/assets/js/19.f10316de.js"><link rel="prefetch" href="/blog/assets/js/20.4c11b076.js"><link rel="prefetch" href="/blog/assets/js/21.ceb3b920.js"><link rel="prefetch" href="/blog/assets/js/22.5de30657.js"><link rel="prefetch" href="/blog/assets/js/23.f0173a34.js"><link rel="prefetch" href="/blog/assets/js/25.8bd8c2c3.js"><link rel="prefetch" href="/blog/assets/js/3.1bd67bfe.js"><link rel="prefetch" href="/blog/assets/js/4.69e95b75.js"><link rel="prefetch" href="/blog/assets/js/5.83a5511f.js"><link rel="prefetch" href="/blog/assets/js/6.3c2a093e.js"><link rel="prefetch" href="/blog/assets/js/7.38b54764.js"><link rel="prefetch" href="/blog/assets/js/8.6ee2f7a3.js"><link rel="prefetch" href="/blog/assets/js/9.c792a14a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b6bfb1ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suky blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/modules/" class="nav-link">
  功能实现
</a></div><div class="nav-item"><a href="/blog/theory/" class="nav-link">
  理论
</a></div><div class="nav-item"><a href="/blog/visualization/" class="nav-link router-link-active">
  可视化
</a></div><div class="nav-item"><a href="/blog/engineering/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/else/" class="nav-link">
  其他
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/modules/" class="nav-link">
  功能实现
</a></div><div class="nav-item"><a href="/blog/theory/" class="nav-link">
  理论
</a></div><div class="nav-item"><a href="/blog/visualization/" class="nav-link router-link-active">
  可视化
</a></div><div class="nav-item"><a href="/blog/engineering/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/else/" class="nav-link">
  其他
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/visualization/" aria-current="page" class="sidebar-link">/visualization/</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="canvas-的入门使用"><a href="#canvas-的入门使用" class="header-anchor">#</a> CANVAS 的入门使用</h1> <h2 id="简单使用"><a href="#简单使用" class="header-anchor">#</a> 简单使用</h2> <p>canvas 本质来说就是一块画布，我们可以在其中进行各种图形的操作，而我们最常用的就是用来绘制动画，因为他的频繁刷新并不会导致 DOM 节点的改变，也因此不会导致页面的不断重排重绘，实在是动画的好帮手。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 获取画布</span>
<span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 画图</span>
ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>cacheCanvas<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 画图形</span>
ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#ebebeb&quot;</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cacheCanvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> cacheCanvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 写字</span>
ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">&quot;your text&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 清除画布</span>
ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这边我总结了一下我们常用 Canvas 大概就做几件事：</p> <ul><li>游戏开发</li> <li>绘制截图</li> <li>进行视频绘制</li> <li>数据报表绘制</li></ul> <h2 id="游戏开发"><a href="#游戏开发" class="header-anchor">#</a> 游戏开发</h2> <ul><li>ctx.drawImage 的显示 <code>ctx.drawImage(pic, sX, sY, sWid, sHei, dX, dY, dWid, dHei)</code></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 框架</span>
<span class="token comment">// JAVASCRIPT CODE //</span>
<span class="token comment">/* 全局变量 */</span>
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'mycanvas'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> frames <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">/** 跟踪游戏绘制帧数 */</span>
<span class="token keyword">const</span> <span class="token constant">DEGREE</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span> <span class="token comment">// 一角度是多少PI</span>

<span class="token comment">/** 加载图片资源 */</span>
<span class="token keyword">const</span> sprite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sprite<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'img/sprite.png'</span>

<span class="token comment">/** 加载声音文件 */</span>
<span class="token keyword">const</span> <span class="token constant">SCORE_S</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Audio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">SCORE_S</span><span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;audio/sfx_point.wav&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/** 定义背景 */</span>
<span class="token keyword">const</span> bg <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/** 定义前景 */</span>
<span class="token keyword">const</span> fg <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/** 定义小鸟 */</span>
<span class="token keyword">const</span> bird <span class="token operator">=</span> <span class="token punctuation">{</span>
    animation<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>sX<span class="token operator">:</span> <span class="token number">276</span><span class="token punctuation">,</span> sY<span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>sX<span class="token operator">:</span> <span class="token number">276</span><span class="token punctuation">,</span> sY<span class="token operator">:</span> <span class="token number">139</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>sX<span class="token operator">:</span> <span class="token number">276</span><span class="token punctuation">,</span> sY<span class="token operator">:</span> <span class="token number">164</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>sX<span class="token operator">:</span> <span class="token number">276</span><span class="token punctuation">,</span> sY<span class="token operator">:</span> <span class="token number">139</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    x<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
    y<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    w<span class="token operator">:</span> <span class="token number">34</span><span class="token punctuation">,</span>
    h<span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
    frame<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    speed<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    gravity<span class="token operator">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
    jump<span class="token operator">:</span> <span class="token number">4.6</span><span class="token punctuation">,</span>
    rotation<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    radius<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">// 用于碰撞检测</span>
    <span class="token function-variable function">draw</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">flap</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 点击事件</span>
    <span class="token function-variable function">update</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 更新事件</span>
    <span class="token function-variable function">speedReset</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 回置</span>
<span class="token punctuation">}</span>

<span class="token comment">// 字面量进行保存</span>
<span class="token comment">/** 定义管道 */</span>
<span class="token keyword">const</span> pipes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/** 计算得分 */</span>
<span class="token keyword">const</span> score <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/** GET READY */</span>
<span class="token keyword">const</span> getReady <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/** GAME OVER */</span>
<span class="token keyword">const</span> gameOver <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/** 游戏状态 */</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
    current<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    getReady<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    game<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    gameOver<span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> startBtn <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/* 画布点击事件 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 绘图逻辑 */</span>
<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/** 绘制与现存的canvas 容器等大的矩形 */</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#70c5ce'</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
    <span class="token comment">/** 绘制图像 */</span>
    bg<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 更新逻辑 */</span>
<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fg<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 循环逻辑
   更新本质: 更新各个物品的坐标
*/</span>
<span class="token keyword">function</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    frames<span class="token operator">++</span>

    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="检测资源加载进度"><a href="#检测资源加载进度" class="header-anchor">#</a> 检测资源加载进度</h3> <p>我们对检测资源加载进度这件事通常认为，当我们静态资源加载完，这个网页就真的加载完了，因此我们检测网页加载进度就是检测静态资源加载进度。
但如果在一般网页中，因为我们还会有大量图片是使用<code>background-image</code>引用的，就不适合通过检测静态资源加载进度来显示加载进度，而会直接采取<code>addEventListener('load')</code>配合 loading 动画来显示</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/** 加载资源 */</span>
<span class="token keyword">let</span> resources <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;sprite&quot;</span><span class="token punctuation">,</span>
    src<span class="token operator">:</span> <span class="token string">&quot;img/sprite.png&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;SCORE_S&quot;</span><span class="token punctuation">,</span>
    src<span class="token operator">:</span> <span class="token string">&quot;audio/sfx_point.wav&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;FLAP&quot;</span><span class="token punctuation">,</span>
    src<span class="token operator">:</span> <span class="token string">&quot;audio/sfx_flap.wav&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;HIT&quot;</span><span class="token punctuation">,</span>
    src<span class="token operator">:</span> <span class="token string">&quot;audio/sfx_hit.wav&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;SWOOSHING&quot;</span><span class="token punctuation">,</span>
    src<span class="token operator">:</span> <span class="token string">&quot;audio/sfx_swooshing.wav&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;DIE&quot;</span><span class="token punctuation">,</span>
    src<span class="token operator">:</span> <span class="token string">&quot;audio/sfx_die.wav&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">/** 加载图片 */</span>
<span class="token keyword">function</span> <span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token parameter">images</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> len <span class="token operator">=</span> images<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">[</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">[</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">=</span> images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    obj<span class="token punctuation">[</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      current <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resources <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        resources <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;startLoadAudio&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 加载音乐 */</span>
<span class="token keyword">function</span> <span class="token function">loadAudio</span><span class="token punctuation">(</span><span class="token parameter">audio</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> len <span class="token operator">=</span> audio<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 音频文件</span>
    obj<span class="token punctuation">[</span>audio<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Audio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">[</span>audio<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">=</span> audio<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    audio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">[</span>audio<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;canplay&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      current <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resources <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resources<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;audioLoadFinished&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">loadResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> images <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;png&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> item<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;jpg&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> audio <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;wav&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> item<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;mp3&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> audio<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">loadImages</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;startLoadAudio&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">loadAudio</span><span class="token punctuation">(</span>audio<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;audioLoadFinished&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/** game start */</span>
    <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">loadResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="游戏状态维护"><a href="#游戏状态维护" class="header-anchor">#</a> 游戏状态维护</h3> <p>canvas 是无法检测某些物品是否要绘制，因此如果我们有几个不同的场景进行切换时，需要通过 state 来进行状态维护</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
  current<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  getReady<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  game<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  gameOver<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="游戏角色动起来"><a href="#游戏角色动起来" class="header-anchor">#</a> 游戏角色动起来</h3> <p>动画我们一般分为两种，一种是状态动画，通过改变他的 css 属性来达成，另一种是帧动画，通过不断更换图片达成视觉暂留效果,那作为游戏角色通常都是使用帧动画,因为 canvas 的更新速度为 60 帧每秒，如果根据 canvas 更新速度来更新动画，我们肉眼很可能察觉不出动画变化，所以我们会设置一个变量<code>frames</code>来控制更换速度。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>animation<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> sX<span class="token operator">:</span> <span class="token number">276</span><span class="token punctuation">,</span> sY<span class="token operator">:</span> <span class="token number">112</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> sX<span class="token operator">:</span> <span class="token number">276</span><span class="token punctuation">,</span> sY<span class="token operator">:</span> <span class="token number">139</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> sX<span class="token operator">:</span> <span class="token number">276</span><span class="token punctuation">,</span> sY<span class="token operator">:</span> <span class="token number">164</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> sX<span class="token operator">:</span> <span class="token number">276</span><span class="token punctuation">,</span> sY<span class="token operator">:</span> <span class="token number">139</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 每更新5帧动画更新一次</span>
  <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>frame <span class="token operator">+=</span> frames <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>period <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>frame <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animation<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

<span class="token keyword">let</span> bird <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animation<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>frame<span class="token punctuation">]</span><span class="token punctuation">;</span>

ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
  sprite<span class="token punctuation">,</span>
  bird<span class="token punctuation">.</span>sX<span class="token punctuation">,</span>
  bird<span class="token punctuation">.</span>sY<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>h
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="想要物品旋转"><a href="#想要物品旋转" class="header-anchor">#</a> 想要物品旋转</h3> <p>canvas 中物品旋转的话会使整个画布都旋转起来，因此我们会将要旋转的东西放在最后渲染，并且要通过<code>ctx.save</code>和<code>ctx.restore</code>来储存和恢复未旋转前的画布状态</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// old state</span>
ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 让小鸟能够旋转</span>
ctx<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 减去的是为了让小鸟停在中心</span>
ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
  sprite<span class="token punctuation">,</span>
  bird<span class="token punctuation">.</span>sX<span class="token punctuation">,</span>
  bird<span class="token punctuation">.</span>sY<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>h
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// back to old state</span>
ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="在某块位置发生点击事件"><a href="#在某块位置发生点击事件" class="header-anchor">#</a> 在某块位置发生点击事件</h3> <p>因为 canvas 只能绑定一个 DOM 事件，所以对于不同场景，某些位置的点击事件只能通过判断解决</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> state<span class="token punctuation">.</span>getReady<span class="token operator">:</span>
      state<span class="token punctuation">.</span>current <span class="token operator">=</span> state<span class="token punctuation">.</span>game<span class="token punctuation">;</span>
      <span class="token constant">SWOOSHING</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> state<span class="token punctuation">.</span>game<span class="token operator">:</span>
      bird<span class="token punctuation">.</span><span class="token function">flap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token constant">FLAP</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> state<span class="token punctuation">.</span>gameOver<span class="token operator">:</span>
      <span class="token keyword">let</span> rect <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> clickX <span class="token operator">=</span> event<span class="token punctuation">.</span>clientX <span class="token operator">-</span> rect<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
      <span class="token keyword">let</span> clickY <span class="token operator">=</span> event<span class="token punctuation">.</span>clientY <span class="token operator">-</span> rect<span class="token punctuation">.</span>top<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        clickX <span class="token operator">&gt;=</span> startBtn<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span>
        clickX <span class="token operator">&lt;=</span> startBtn<span class="token punctuation">.</span>x <span class="token operator">+</span> startBtn<span class="token punctuation">.</span>w <span class="token operator">&amp;&amp;</span>
        clickY <span class="token operator">&gt;=</span> startBtn<span class="token punctuation">.</span>y <span class="token operator">&amp;&amp;</span>
        clickY <span class="token operator">&lt;=</span> startBtn<span class="token punctuation">.</span>y <span class="token operator">+</span> startBtn<span class="token punctuation">.</span>h
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pipes<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bird<span class="token punctuation">.</span><span class="token function">speedReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        score<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        state<span class="token punctuation">.</span>current <span class="token operator">=</span> state<span class="token punctuation">.</span>getReady<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="音乐重复播放"><a href="#音乐重复播放" class="header-anchor">#</a> 音乐重复播放</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">SOUND_BG</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Audio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">SOUND_BG</span><span class="token punctuation">.</span>src <span class="token operator">=</span>
  <span class="token string">&quot;https://founq.oss-cn-shanghai.aliyuncs.com/video/yanghouziH5/peach%20beijing&quot;</span><span class="token punctuation">;</span>
<span class="token constant">SOUND_BG</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;ended&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="设置画布规定大小"><a href="#设置画布规定大小" class="header-anchor">#</a> 设置画布规定大小</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>PickPeach<span class="token punctuation">.</span>canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;pickPeach&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PickPeach<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">&quot;6.4rem&quot;</span><span class="token punctuation">;</span>
PickPeach<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">&quot;12.5rem&quot;</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="数组的变动导致屏幕的闪屏"><a href="#数组的变动导致屏幕的闪屏" class="header-anchor">#</a> 数组的变动导致屏幕的闪屏</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">game</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 物品更新 */</span>
  arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>isLive <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>needToClear<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 更新我们的canvas */</span>
  window<span class="token punctuation">.</span><span class="token function">requestAnimFrame</span><span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如上这段代码咋看并没有什么问题，就是一个数组，我们希望满足一定条件时能够删除，但是在实际运行的时候页面就会出现以下的情况。
<img src="/images/%E9%97%AA%E5%B1%8F.gif" alt="">
就有很明显的卡一下的痕迹（图不是很明显），后来检测发现主要是页面不断在更新，而数组的处理是需要一点时间，这样的冲突下就会导致页面卡一下，只要我们在页面内设置定时，每隔一段时间在进行处理，这个问题就可以解决</p> <h3 id="双缓存解决绘制时间较长的问题"><a href="#双缓存解决绘制时间较长的问题" class="header-anchor">#</a> 双缓存解决绘制时间较长的问题</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">game</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 更新时缓存画布直接复制过去</span>
  ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>cacheCanvas<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 东西绘制在缓存canvas</span>
  cacheCtx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#ebebeb&quot;</span><span class="token punctuation">;</span>
  cacheCtx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cacheCanvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> cacheCanvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 更新我们的canvas */</span>
  window<span class="token punctuation">.</span><span class="token function">requestAnimFrame</span><span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>链接参考:
<a href="https://juejin.im/post/6844903832439242766" target="_blank" rel="noopener noreferrer">使用双缓存解决 Canvas clearRect 引起的闪屏问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.cnblogs.com/kenkofox/p/4950727.html" target="_blank" rel="noopener noreferrer">【H5 动画】谈谈 canvas 动画的闪烁问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.youtube.com/watch?v=0ArCFchlTq4&amp;t=17s" target="_blank" rel="noopener noreferrer">Create The Original Flappy Bird Game Using JavaScript and HTML5 canvas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="截图"><a href="#截图" class="header-anchor">#</a> 截图</h2> <p>最常用就是营销活动中用来进行用户二维码截图，这样我们后端就不需要在服务器中保存无数张用户截图，我们前端也不需要等待许久才能得到这一张图。</p> <p>借助插件</p> <ul><li>html2canvas.js</li> <li>canvas2img.js</li> <li>qrcode.min.js</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 检测图片是否已经生成</span>
<span class="token keyword">function</span> <span class="token function">noCanvas</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> canScreenshot <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  dom<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>classList <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;screenshot&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      canScreenshot <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> canScreenshot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 长按保存图片
 */</span>
<span class="token keyword">function</span> <span class="token function">saveImg</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">DOM</span><span class="token punctuation">,</span> fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 想要保存的图片节点</span>
  <span class="token keyword">const</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token constant">DOM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 假如已经生成节点了，直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">noCanvas</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//TODO 创建一个新的canvas</span>

      <span class="token comment">// TODO 将Canvas画布放大scale倍，然后放在小的屏幕里，解决模糊问题</span>

      <span class="token comment">// TODO 使用插件捷星截图</span>
      <span class="token function">html2canvas</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        canvas<span class="token operator">:</span> Canvas<span class="token punctuation">,</span>
        scale<span class="token punctuation">,</span>
        useCORS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        logging<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        scrollY<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        scrollX<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        backgroundColor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>

        <span class="token comment">// 替换图片</span>
        <span class="token keyword">const</span> img <span class="token operator">=</span> Canvas2Image<span class="token punctuation">.</span><span class="token function">convertToPNG</span><span class="token punctuation">(</span>
          canvas<span class="token punctuation">,</span>
          canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
          canvas<span class="token punctuation">.</span>height
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">&quot;absolute&quot;</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>style<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token constant">DOM</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>style<span class="token punctuation">.</span>zIndex <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;screenshot&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token constant">DOM</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 有些浏览器不能检测到base64的img标签，也就无法长按保存图片，因此现在是使用覆盖且长按下载来做的</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token constant">DOM</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longPress</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          Canvas2Image<span class="token punctuation">.</span><span class="token function">saveAsPNG</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="视频绘制"><a href="#视频绘制" class="header-anchor">#</a> 视频绘制</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;video&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">TOLERANCE</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment">// IMPORTANT 进行每个点的过滤</span>
<span class="token keyword">function</span> <span class="token function">cutOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> frameData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
    len <span class="token operator">=</span> frameData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> r <span class="token operator">=</span> frameData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      g <span class="token operator">=</span> frameData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      b <span class="token operator">=</span> frameData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> <span class="token number">100</span> <span class="token operator">&gt;=</span> <span class="token constant">TOLERANCE</span> <span class="token operator">&amp;&amp;</span> g <span class="token operator">-</span> <span class="token number">100</span> <span class="token operator">&gt;=</span> <span class="token constant">TOLERANCE</span> <span class="token operator">&amp;&amp;</span> b <span class="token operator">-</span> <span class="token number">43</span> <span class="token operator">&lt;=</span> <span class="token constant">TOLERANCE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      frameData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> frameData<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token punctuation">.</span>paused <span class="token operator">||</span> video<span class="token punctuation">.</span>ended<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>video<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">putImageData</span><span class="token punctuation">(</span><span class="token function">cutOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
video<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;play&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="数据报表绘制"><a href="#数据报表绘制" class="header-anchor">#</a> 数据报表绘制</h2> <p><code>echarts</code>的图表大部分就是基于<code>canvas</code>绘图的，有兴趣可以看看</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8a54f0e1.js" defer></script><script src="/blog/assets/js/2.99672014.js" defer></script><script src="/blog/assets/js/24.225aca0c.js" defer></script>
  </body>
</html>
